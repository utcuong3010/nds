DROP TABLE IF EXISTS `airtime_config`;
DROP TABLE IF EXISTS `alert_contact`;
DROP TABLE IF EXISTS `at_summary`;
DROP TABLE IF EXISTS `at_transaction_history`;

DROP VIEW IF EXISTS `txn_summary_view`;
DROP VIEW IF EXISTS `provider_money_summary_view`;
DROP VIEW IF EXISTS `txn_provider_summary_view`;
DROP VIEW IF EXISTS `at_summary_view`;

ALTER TABLE `queue_request` CHANGE COLUMN `content` `content` VARCHAR(2500) CHARACTER SET 'utf8' NULL DEFAULT NULL  ;
ALTER TABLE `at_transaction` DROP COLUMN `network_code` , ADD COLUMN `response_date` DATETIME NULL DEFAULT NULL  AFTER `delivery_date` , ADD COLUMN `txn_status` VARCHAR(50) NULL DEFAULT 'PENDING'  AFTER `error_code` , CHANGE COLUMN `message_id` `message_id` VARCHAR(20) NULL DEFAULT NULL  , CHANGE COLUMN `msg_type` `msg_type` ENUM('0200','0800') NULL  ;
ALTER TABLE `at_transaction` CHANGE COLUMN `msg_type` `msg_type` VARCHAR(50) NULL DEFAULT NULL  , CHANGE COLUMN `status` `status` VARCHAR(50) NOT NULL DEFAULT 'PENDING'  ;
ALTER TABLE `at_transaction` ADD INDEX `txn_status_del_index` (`txn_status` ASC, `deleted` ASC) , ADD INDEX `txn_status_index` (`txn_status` ASC) ;


update `at_transaction` set txn_status='SUCCESS' where status='DELIVERED' and (error_code='00' or error_code='SUCCESS');
update `at_transaction` set txn_status='ERROR' where status='DELIVERED' and (error_code<>'00' and error_code<>'SUCCESS');
update `at_transaction` set txn_status='ERROR' where status='ERROR';
update `at_transaction` set txn_status='ERROR' where status='PENDING';
update `at_transaction` set txn_status='ERROR' where status='DELIVERING';

DROP TABLE IF EXISTS `provider_amount`;

CREATE TABLE `provider_amount` (
  `provider_id` varchar(50) NOT NULL,
  `total_loaded` bigint(20) DEFAULT '0',
  `total_used` bigint(20) DEFAULT '0',
  `notif_amount` bigint(20) DEFAULT '0',
  `notif_sent` tinyint(1) DEFAULT '0',
  PRIMARY KEY (`provider_id`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

INSERT INTO `provider_amount` VALUES ('MOBI',0,0,0,0),('VNPAY',0,0,0,0),('VTEL',0,0,0,0);

DROP TABLE IF EXISTS `airtime_config`;
CREATE TABLE `airtime_config` (
  `module` varchar(50) NOT NULL,
  `type` varchar(255) NOT NULL,
  `param_key` varchar(255) NOT NULL,
  `param_value` varchar(4000) CHARACTER SET utf8 DEFAULT NULL,
  `value_type` varchar(50) DEFAULT 'prop',
  `remote_key` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`module`,`type`,`param_key`)
) ENGINE=InnoDB DEFAULT CHARSET=ascii;

INSERT INTO `airtime_config` VALUES ('airtime','config','airtime.constant.airtime-provider','<?xml version=\"1.0\" encoding=\"ISO-8859-1\" ?>\n<app>\n<airtime>\n<constant>\n<airtime-provider> \n                <provider id=\"VTEL\" name=\"Viettel\"/>\n	<provider id=\"MOBI\" name=\"MobiFone\"/>\n	<provider id=\"VNPAY\" name=\"VnPay\"/>\n</airtime-provider>\n</constant>\n</airtime>\n</app>','xml',NULL),('airtime','config','airtime.constant.inquiry-max-timeout','600000','prop',NULL),('airtime','config','airtime.constant.integation-gateway','<?xml version=\"1.0\" encoding=\"ISO-8859-1\" ?>\n<app>\n	<integation>\n		<client>\n			<gateway>\n				<module>AirTimeAdmin</module>\n                                                                <client-connection-type>COMMON</client-connection-type>\n				<local-enable>false</local-enable>\n				<name>WorkFlowConnection</name>\n				<host>localhost</host>\n				<port>5102</port>\n				<pool-size>2</pool-size>\n			</gateway>\n			<gateway>\n				<module>AirTimeGateWay</module>\n				<client-connection-type>TOPUP</client-connection-type>\n				<local-enable>false</local-enable>\n				<name>WorkFlowConnection</name>\n				<host>localhost</host>\n				<port>5102</port>\n				<pool-size>10</pool-size>\n			</gateway>\n			<gateway>\n				<module>AirTimeGateWay</module>\n				<client-connection-type>INQUIRY</client-connection-type>\n				<local-enable>false</local-enable>\n				<name>WorkFlowConnection</name>\n				<host>localhost</host>\n				<port>5102</port>\n				<pool-size>40</pool-size>\n			</gateway>\n			<gateway>\n				<module>Application</module>\n				<client-connection-type>COMMON</client-connection-type>\n				<name>QueueConnection</name>\n				<local-enable>true</local-enable>\n				<class>com.mbv.bp.queue.integration.QueueLocalExecutor</class>\n				<host>localhost</host>\n				<port>5101</port>\n				<pool-size>50</pool-size>\n			</gateway>\n			<gateway>\n				<module>Application</module>\n				<client-connection-type>COMMON</client-connection-type>\n				<local-enable>false</local-enable>\n				<name>VNPAY</name>\n				<host>localhost</host>\n				<port>1010</port>  \n				<pool-size>1</pool-size>\n			</gateway>\n			<gateway>\n				<module>Application</module>\n				<client-connection-type>COMMON</client-connection-type>\n				<local-enable>false</local-enable>\n				<name>MOBI</name>\n				<host>http://localhost:8080/mobi-gateway-simulator/services/UMarketSC</host>\n                                                              	<port>0</port>  \n				<pool-size>1</pool-size>\n			</gateway>\n                                                <gateway>\n				<module>Application</module>\n				<client-connection-type>COMMON</client-connection-type>\n				<local-enable>false</local-enable>\n				<name>VTEL</name>\n				<host>localhost</host>\n				<port>6868</port>  \n				<pool-size>10</pool-size>\n			</gateway>\n			<gateway>\n				<module>Application</module>\n				<client-connection-type>COMMON</client-connection-type>\n				<name>WorkFlowConnection</name>\n				<local-enable>true</local-enable>\n				<class>com.mbv.bp.core.integration.WfpLocalExecutor</class>\n				<host>localhost</host>\n				<port>5102</port>\n				<pool-size>50</pool-size>\n			</gateway>\n		</client>\n	</integation>\n</app>','xml',NULL),('airtime','config','airtime.constant.telco-provider','<?xml version=\"1.0\" encoding=\"ISO-8859-1\" ?>\n<app>\n	<airtime>\n		<constant>\n			<telco-provider> \n				<provider id=\"VTEL\" name=\"Viettel\">\n					<connection-id>VTEL</connection-id>\n				</provider>\n				<provider id=\"MOBI\" name=\"MobiFone\">\n					<connection-id>MOBI</connection-id>\n				</provider>\n				<provider id=\"VINA\" name=\"VinaPhone\">\n					<connection-id>VNPAY</connection-id>\n				</provider>\n				<provider id=\"BLVN\" name=\"Beeline VietNam\">\n					<connection-id>VNPAY</connection-id>\n				</provider>\n				<provider id=\"SFON\" name=\"S-Fone\">\n					<connection-id>VNPAY</connection-id>\n				</provider>\n				<provider id=\"EVNT\" name=\"EVN Telecom\">\n					<connection-id>VNPAY</connection-id>\n				</provider>\n				<provider id=\"VNMB\" name=\"Vietnam Mobile\">\n					<connection-id>VNPAY</connection-id>\n				</provider>\n			</telco-provider>\n		</constant>\n	</airtime>\n</app>','xml',NULL),('airtime','config','app-context-loader.airtime-launcher','common-context.xml,workflow-context.xml,queue-context.xml,scheduler-context.xml','prop',NULL),('cdrsync','cacher','mobifone.last-export-date','20110921','prop',NULL),('cdrsync','cacher','mobifone.last-import-date','0','prop',NULL),('cdrsync','cacher','viettel.last-export-date','20110920172938','prop',NULL),('cdrsync','cacher','viettel.last-import-date','20110917035749','prop',NULL),('gateway','config','gateway.constant.error-convert','<?xml version=\"1.0\" encoding=\"ISO-8859-1\" ?>\n<app>\n	<gateway>\n		<airtime>\n			<error-convert>\n				<method id=\"TOPUP\">\n					<type id=\"sys-error\">\n						<default-error>SYS_INTERNAL_ERROR</default-error>\n						<bypass-error>SUCCESS</bypass-error>\n						<bypass-error>INVALID_REQUEST</bypass-error>\n					</type>\n					<type id=\"txn-error\">\n						<!--default-error>TRANSACTION_FAILED</default-error-->\n						<default-error>TRANSACTION_ERROR</default-error>\n						<bypass-error>SUCCESS</bypass-error>\n						<bypass-error>REQUEST_TIME_OUT</bypass-error>\n						<bypass-error>UNSUPPORTED_NUMBER</bypass-error>\n						<bypass-error>MISISDN_NOT_EXISTED</bypass-error>\n						<bypass-error>SYS_NOT_ENOUGH_MONEY</bypass-error>\n						<bypass-error>DELIVERY_RESPONSE_ERROR</bypass-error>\n						<bypass-error>INVALID_RESPONSE</bypass-error>\n<bypass-error>UMARKET_76</bypass-error>\n<bypass-error>UMARKET_77</bypass-error>\n<bypass-error>UMARKET_78</bypass-error>\n						<bypass-error>00</bypass-error>\n					</type>\n				</method>\n				\n				<method id=\"INQUIRY\">\n					<type id=\"sys-error\">\n						<default-error>SYS_INTERNAL_ERROR</default-error>\n						<bypass-error>SUCCESS</bypass-error>\n						<bypass-error>TXN_NOT_EXISTED</bypass-error>\n					</type>\n					<type id=\"txn-error\">\n						<!--default-error>TRANSACTION_FAILED</default-error-->\n						<default-error>TRANSACTION_ERROR</default-error>\n						<bypass-error>SUCCESS</bypass-error>\n						<bypass-error>REQUEST_TIME_OUT</bypass-error>\n						<bypass-error>UNSUPPORTED_NUMBER</bypass-error>\n						<bypass-error>MISISDN_NOT_EXISTED</bypass-error>\n						<bypass-error>SYS_NOT_ENOUGH_MONEY</bypass-error>\n						<bypass-error>DELIVERY_RESPONSE_ERROR</bypass-error>\n						<bypass-error>INVALID_RESPONSE</bypass-error>\n<bypass-error>UMARKET_76</bypass-error>\n<bypass-error>UMARKET_77</bypass-error>\n<bypass-error>UMARKET_78</bypass-error>\n						<bypass-error>00</bypass-error>\n					</type>\n				</method>\n			</error-convert>\n		</airtime>\n	</gateway>\n</app>','xml',NULL),('mobifone','config','settings.mobifone.amount-validate','true','prop',NULL),('mobifone','config','settings.mobifone.buy-type','2','prop',NULL),('mobifone','config','settings.mobifone.cdr-processor-queue-id','CDR_PROCESSSOR','prop',NULL),('mobifone','config','settings.mobifone.cdr-processor-wfp','cdrProcessorWfp','prop',NULL),('mobifone','config','settings.mobifone.client-id','4','prop',NULL),('mobifone','config','settings.mobifone.file-prefix','mobivi_buy_trans','prop',NULL),('mobifone','config','settings.mobifone.from-lastdate-to-current-date','0','prop',NULL),('mobifone','config','settings.mobifone.inquiry-max-retry','3','prop',NULL),('mobifone','config','settings.mobifone.invalid-unloged-session-time','30000','prop',NULL),('mobifone','config','settings.mobifone.local-mobifone-path','D:/ftp-simulator/local','prop','/opt/ftp/mobifone'),('mobifone','config','settings.mobifone.local-mobivi-path','D:/ftp-simulator/local','prop','/opt/ftp/mobivi'),('mobifone','config','settings.mobifone.max-error','50','prop',NULL),('mobifone','config','settings.mobifone.max-seq-error','5','prop',NULL),('mobifone','config','settings.mobifone.mobifone-ftp-host','localhost','prop','10.151.89.38'),('mobifone','config','settings.mobifone.mobifone-ftp-passive-mode','true','prop',NULL),('mobifone','config','settings.mobifone.mobifone-ftp-password','mobifone4mobivi','prop','mobivi@123'),('mobifone','config','settings.mobifone.mobifone-ftp-port','21','prop',NULL),('mobifone','config','settings.mobifone.mobifone-ftp-username','mobifone4mobivi','prop','mobivi'),('mobifone','config','settings.mobifone.mobivi-ftp-host','localhost','prop',NULL),('mobifone','config','settings.mobifone.mobivi-ftp-password','mobivi4mobifone','prop',NULL),('mobifone','config','settings.mobifone.mobivi-ftp-port','21','prop',NULL),('mobifone','config','settings.mobifone.mobivi-ftp-username','mobivi4mobifone','prop',NULL),('mobifone','config','settings.mobifone.next-id-max-retry','3','prop',NULL),('mobifone','config','settings.mobifone.password','20110914','prop',NULL),('mobifone','config','settings.mobifone.process-result-time','10000','prop',NULL),('mobifone','config','settings.mobifone.remote-mobifone-path','','prop',NULL),('mobifone','config','settings.mobifone.remote-mobivi-path','/mb-airtime','prop',NULL),('mobifone','config','settings.mobifone.session-id','Q5WZ0UGXZKOOQ0ASW1LO','prop',NULL),('mobifone','config','settings.mobifone.session-verified','false','prop',NULL),('mobifone','config','settings.mobifone.sync-file-extension','.log','prop',NULL),('mobifone','config','settings.mobifone.temp-file-extension','.tmp','prop',NULL),('mobifone','config','settings.mobifone.time-out','10000','prop',NULL),('mobifone','config','settings.mobifone.username','mobivi','prop',NULL),('notification','config','settings.notification.comparison-status','<?xml version=\"1.0\" encoding=\"ISO-8859-1\" ?>\n<app>\n<notification>\n<comparison-status>\n	<from>admintool@mobivi.com</from>\n	<to>toan.tran@mobivi.com\\,yen.pham@mobivi.com</to>\n	<cc></cc>\n	<bcc></bcc>\n	<subject>\n		<![CDATA[ \n		Canh bao lech doi soat $provider_id\n		]]>\n	</subject>\n	<content> \n	<![CDATA[\n		LÃ¡Â»â€¡ch Ã„â€˜Ã¡Â»â€˜i soÃƒÂ¡t giÃ¡Â»Â¯a hÃ¡Â»â€¡ thÃ¡Â»â€˜ng MobiVÃƒÂ­ vÃƒÂ  hÃ¡Â»â€¡ thÃ¡Â»â€˜ng $provider_id<br>TÃ¡Â»Â« $from_date Ã„â€˜Ã¡ÂºÂ¿n $to_date<br>SÃ¡Â»â€˜ lÃ†Â°Ã¡Â»Â£ng lÃ¡Â»â€¡ch Ã„â€˜Ã¡Â»â€˜i soÃƒÂ¡t: $total_unmatched\n	]]>\n	</content>\n</comparison-status>	\n</notification>\n</app>','xml',NULL),('notification','config','settings.notification.conn-status','<?xml version=\"1.0\" encoding=\"ISO-8859-1\" ?>\n<app>\n<notification>\n<conn-status>\n	<from>admintool@mobivi.com</from>\n	<to>toan.tran@mobivi.com</to>\n	<cc></cc>\n	<bcc></bcc>\n	<subject>\n		<![CDATA[ \n		conn-status\n		]]>\n	</subject>\n	<content> \n	<![CDATA[\n		conn-status	\n	]]>\n	</content>\n</conn-status>	\n</notification>\n</app>','xml',NULL),('notification','config','settings.notification.email-host','localhost','prop',NULL),('notification','config','settings.notification.email-port','25','prop',NULL),('notification','config','settings.notification.log-email-enable','true','prop',NULL),('notification','config','settings.notification.mobi-err','<?xml version=\"1.0\" encoding=\"ISO-8859-1\" ?>\n<app>\n<notification>\n<mobi-err>\n	<from>admintool@mobivi.com</from>\n	<to>toan.tran@mobivi.com</to>\n	<cc></cc>\n	<bcc></bcc>\n	<subject>\n	<![CDATA[ \n		Canh bao giao dich loi MobiVi Airtime (Mobifone)  \n	]]>\n	</subject>\n	<content> \n	<![CDATA[\n		HÃ¡Â»â€¡ thÃ¡Â»â€˜ng MobiVÃƒÂ­ Airtime xuÃ¡ÂºÂ¥t hiÃ¡Â»â€¡n giao dÃ¡Â»â€¹ch lÃ¡Â»â€”i:<br> $detail\n	]]>\n	</content>\n</mobi-err>	\n</notification>\n</app>','xml',NULL),('notification','config','settings.notification.mobi-seq-err','<?xml version=\"1.0\" encoding=\"ISO-8859-1\" ?>\n<app>\n<notification>\n<mobi-seq-err>\n	<from>admintool@mobivi.com</from>\n	<to>toan.tran@mobivi.com</to>\n	<cc></cc>\n	<bcc></bcc>\n	<subject>\n	<![CDATA[ \n		Canh bao giao dich loi lien tiep he thong MobiVÃƒÂ­ Airtime (Mobifone)\n	]]>\n	</subject>\n	<content> \n	<![CDATA[\n		HÃ¡Â»â€¡ thÃ¡Â»â€˜ng MobiVÃƒÂ­ Airtime (Mobifone) xuÃ¡ÂºÂ¥t hiÃ¡Â»â€¡n giao dÃ¡Â»â€¹ch lÃ¡Â»â€”i liÃƒÂªn tiÃ¡ÂºÂ¿p:<br>$detail 		\n	]]>\n	</content>\n</mobi-seq-err>	\n</notification>\n</app>','xml',NULL),('notification','config','settings.notification.not-enough-money','<?xml version=\"1.0\" encoding=\"ISO-8859-1\" ?>\n<app>\n<notification>\n<not-enough-money>\n	<from>admintool@mobivi.com</from>\n	<to>toan.tran@mobivi.com</to>\n	<cc></cc>\n	<bcc></bcc>\n	<subject>\n		<![CDATA[ \n		Canh bao tai khoan $provider_id sap het tien \n		]]>\n	</subject>\n	<content> \n	<![CDATA[\n		TÃƒÂ i khoÃ¡ÂºÂ£n $provider_id sÃ¡ÂºÂ¯p hÃ¡ÂºÂ¿t tiÃ¡Â»ï¿½n <br>SÃ¡Â»â€˜ dÃ†Â° hiÃ¡Â»â€¡n tÃ¡ÂºÂ¡i: $current_amount<br>CÃ¡ÂºÂ£nh bÃƒÂ¡o khi sÃ¡Â»â€˜ dÃ†Â° nhÃ¡Â»ï¿½ hÃ†Â¡n: $notif_amount \n	]]>\n	</content>\n</not-enough-money>	\n</notification>\n</app>','xml',NULL),('notification','config','settings.notification.seq-err','<?xml version=\"1.0\" encoding=\"ISO-8859-1\" ?>\n<app>\n<notification>\n<seq-err>\n	<from>admintool@mobivi.com</from>\n	<to>toan.tran@mobivi.com</to>\n	<cc></cc>\n	<bcc></bcc>\n	<subject>\n	<![CDATA[ \n		Canh bao giao dich loi lien tiep he thong MobiVÃƒÂ­ Airtime ($provider_id)\n	]]>\n	</subject>\n	<content> \n	<![CDATA[\n		HÃ¡Â»â€¡ thÃ¡Â»â€˜ng MobiVÃƒÂ­ Airtime ($provider_id) xuÃ¡ÂºÂ¥t hiÃ¡Â»â€¡n giao dÃ¡Â»â€¹ch lÃ¡Â»â€”i liÃƒÂªn tiÃ¡ÂºÂ¿p:<br>$detail 		\n	]]>\n	</content>\n</seq-err>	\n</notification>\n</app>','xml',NULL),('notification','config','settings.notification.unknown-txn-status','<?xml version=\"1.0\" encoding=\"ISO-8859-1\" ?>\n<app>\n<notification>\n<unknown-txn-status>\n	<from>admintool@mobivi.com</from>\n	<to>toan.tran@mobivi.com</to>\n	<cc></cc>\n	<bcc></bcc>\n	<subject>\n	<![CDATA[ \n		Canh bao KHONG XAC DINH trang thai giao dich ($provider_id)\n	]]>\n	</subject>\n	<content> \n	<![CDATA[\n		HÃ¡Â»â€¡ thÃ¡Â»â€˜ng Airtime xuÃ¡ÂºÂ¥t hiÃ¡Â»â€¡n giao dÃ¡Â»â€¹ch khÃƒÂ´ng xÃƒÂ¡c Ã„â€˜Ã¡Â»â€¹nh Ã„â€˜Ã†Â°Ã¡Â»Â£c trÃ¡ÂºÂ¡ng thÃƒÂ¡i:<br> NhÃƒÂ  cung cÃ¡ÂºÂ¥p: $provider_id<br>SÃ¡Â»â€˜ Ã„â€˜iÃ¡Â»â€¡n thoÃ¡ÂºÂ¡i: $msisdn<br>MÃƒÂ£ giao dÃ¡Â»â€¹ch Airtime-core: $at_txn_id<br>TrÃ¡ÂºÂ¡ng thÃƒÂ¡i: $status 		\n	]]>\n	</content>\n</unknown-txn-status>	\n</notification>\n</app>','xml',NULL),('queue','config','queue.constant.queue-config','<app>\n	<queue>\n		<constant>\n			<queue-config>\n				<queue id=\"VNPAY_DELIVERY\">\n					<max-queue-size>1000</max-queue-size>\n					<dequeue-size>1</dequeue-size>\n					<max-dequeue-retry>0</max-dequeue-retry>\n					<terminable>true</terminable>\n					<queue-table></queue-table>\n				</queue>\n                                                                <queue id=\"VTEL_DELIVERY\">\n					<max-queue-size>1000</max-queue-size>\n					<dequeue-size>10</dequeue-size>\n					<max-dequeue-retry>0</max-dequeue-retry>\n					<terminable>true</terminable>\n					<queue-table></queue-table>\n				</queue>\n				<queue id=\"MOBI_DELIVERY\">\n					<max-queue-size>500</max-queue-size>\n					<dequeue-size>1</dequeue-size>\n					<max-dequeue-retry>0</max-dequeue-retry>\n					<terminable>true</terminable>\n					<queue-table></queue-table>\n				</queue>\n				<queue id=\"AT_DN_PROCESSSOR\">\n					<max-queue-size>10000</max-queue-size>\n					<dequeue-size>30</dequeue-size>\n					<max-dequeue-retry>0</max-dequeue-retry>\n					<terminable>false</terminable>\n					<queue-table></queue-table>\n				</queue>\n				<queue id=\"CDR_PROCESSSOR\">\n					<max-queue-size>10000</max-queue-size>\n					<dequeue-size>30</dequeue-size>\n					<max-dequeue-retry>0</max-dequeue-retry>\n					<terminable>false</terminable>\n					<queue-table></queue-table>\n                                                               </queue>\n			</queue-config>\n		</constant>\n	</queue>\n</app>','xml',NULL),('viettel','config','settings.viettel.amount-validate','true','prop',NULL),('viettel','config','settings.viettel.cdr-processor-queue-id','CDR_PROCESSSOR','prop',NULL),('viettel','config','settings.viettel.cdr-processor-wfp','cdrProcessorWfp','prop',NULL),('viettel','config','settings.viettel.client-id','mobivi','prop',NULL),('viettel','config','settings.viettel.connection-type','VTEL','prop',NULL),('viettel','config','settings.viettel.delivery-queue-id','VTEL_DELIVERY','prop',NULL),('viettel','config','settings.viettel.delivery-wfp','wfpViettelTopupRequestAfterQueue','prop',NULL),('viettel','config','settings.viettel.dn-processor-queue-id','AT_DN_PROCESSSOR','prop',NULL),('viettel','config','settings.viettel.dn-processor-wfp','wfpViettelDnProcessor','prop',NULL),('viettel','config','settings.viettel.ftp-host','localhost','prop','10.58.4.22'),('viettel','config','settings.viettel.ftp-password','viettel4mobivi','prop',NULL),('viettel','config','settings.viettel.ftp-port','21','prop',NULL),('viettel','config','settings.viettel.ftp-username','viettel4mobivi','prop',NULL),('viettel','config','settings.viettel.local-mobivi-path','/opt/ftp','prop','/opt/ftp'),('viettel','config','settings.viettel.local-viettel-path','/opt/ftp','prop','/opt/ftp'),('viettel','config','settings.viettel.max-connection-retry','3','prop',NULL),('viettel','config','settings.viettel.max-pending-request','100','prop',NULL),('viettel','config','settings.viettel.max-pending-response','10','prop',NULL),('viettel','config','settings.viettel.max-seq-error','5','prop',NULL),('viettel','config','settings.viettel.max-unknown-txn-id','5','prop',NULL),('viettel','config','settings.viettel.max-vtel-connection','1','prop',NULL),('viettel','config','settings.viettel.private-key','MIICdgIBADANBgkqhkiG9w0BAQEFAASCAmAwggJcAgEAAoGBAJLCwYOUDrUOXEnYJHMBhf/hb8bPGrdnexwGT60tCW/c1N892/Jj0CITNdwNWJNLh2RBjOMSVspEyOqWEDpRydOmfYG8IIXw0ckFJZk1lwdORw36AaQRurapPZrutIadZHS5ku9qT6qAN40bo3HerL0CYwLhcriA5vG0z9eKJEqxAgMBAAECgYB+OKxQaw0/IOu0wwWON/g0e4Iz/blflctm7fKm4X4lTEt0+PHrBXdjZxxCduQAQsxeKJZwUTx92CzovUmVrvQiG3g52Gjw/Dse8CQLQ2t0txqQpAU7H2W32TG37W5QTSVk2kAibuNTmGIyvsf9K9wq2qKDA7b/x+Ybde1re3B3ZQJBAMm0gxQ28TBTh030jm/RHeGDKTUyN4Ipy4z0a+KthBVVBDwkYSmsWxG00tqCtEglymX63WC3LL4Nwd/pd8SsKdsCQQC6RAgIKexeFJch7K+OlQS5Jfrk1vxNXFGCyaq73PHY5tJmU+DglX3p/qe8yz7XB1Ld5Mxp9uDLLI87hwxkpsFjAkA4QTYFn0UpO0KTRU+sc+AnkxMdGQJONSXmDA1CzS33XRyvQV4v5zgG+i2Mb8OkE5YdVxgC71N1NhUKQ+z5VyLdAkAmxFIHoPIZAqAR53kCa/F3t3foePY6A6TTW7W1M98CDchsk7iSBYsXUHEI0iRaDKQqmpwQ0dkncDa/ZPQnXq2RAkEAlpjvfbt29d/yMvA19tzzDzVkmAlR+is7xg4Nu8n8FgafDdZtrrPQ2JwzJivDX4IpT81CSsN8j99l1MpFa+CFXQ==','prop',NULL),('viettel','config','settings.viettel.process-final-status-time','10000','prop',NULL),('viettel','config','settings.viettel.public-key',' ','prop',NULL),('viettel','config','settings.viettel.remote-mobivi-path','/partner','prop',NULL),('viettel','config','settings.viettel.remote-viettel-path','/viettel','prop',NULL),('viettel','config','settings.viettel.request-operation-type','REQUEST','prop',NULL),('viettel','config','settings.viettel.request-poller-interval','1000','prop',NULL),('viettel','config','settings.viettel.response-codes','<aitime>\n	<settings>\n		<viettel>\n			<response-codes>\n				<response-code src=\"0\" dest=\"00\">success</response-code>\n		        <response-code src=\"94\" dest=\"00\">success with no response</response-code>\n				<response-code src=\"12\" dest=\"SYS_NOT_ENOUGH_MONEY\">not enough money</response-code>\n		        <response-code src=\"13\" dest=\"MISISDN_NOT_EXISTED\">msisnd not exist or not activate</response-code>\n		    </response-codes>\n		</viettel>	\n	</settings>\n</aitime>','xml',NULL),('viettel','config','settings.viettel.response-operation-type','RESPONSE','prop',NULL),('viettel','config','settings.viettel.response-time-out','30000','prop',NULL),('viettel','config','settings.viettel.retry-response-interval','30000','prop',NULL),('viettel','config','settings.viettel.send-network-check-time-interval','150000','prop','150000'),('viettel','config','settings.viettel.success.response-codes','00,94','prop',NULL),('viettel','config','settings.viettel.sync-file-extension','.txt','prop',NULL),('viettel','config','settings.viettel.sync-mid-filename','viettel_sync','prop',NULL),('viettel','config','settings.viettel.sync-time-interval-mins','16','prop',NULL),('viettel','config','settings.viettel.tmp-file-extension','.tmp','prop',NULL),('viettel','config','settings.viettel.txn-time-out','300000','prop','300000'),('viettel','config','settings.viettel.viettel-cdr-end-with','.topup','prop',NULL),('viettel','config','settings.viettel.waiting.response-codes','60,93','prop',NULL),('vnpay','config','settings.vnpay.additional-info-prefix','01014','prop',NULL),('vnpay','config','settings.vnpay.agent-code','101000000030','prop',NULL),('vnpay','config','settings.vnpay.amount-validate','true','prop',NULL),('vnpay','config','settings.vnpay.cdr-processor-queue-id','CDR_PROCESSSOR','prop',NULL),('vnpay','config','settings.vnpay.cdr-processor-wfp','cdrProcessorWfp','prop',NULL),('vnpay','config','settings.vnpay.connection-type','VNPAY','prop',NULL),('vnpay','config','settings.vnpay.delivery-wfp','wfpVnPayTopupRequestAfterQueue','prop',NULL),('vnpay','config','settings.vnpay.dn-processor-queue-id','AT_DN_PROCESSSOR','prop',NULL),('vnpay','config','settings.vnpay.dn-processor-wfp','wfpVnPayDnProcessor','prop',NULL),('vnpay','config','settings.vnpay.id-generator','<aitime>\n	<settings>\n		<vnpay>\n			<id-generator>\n				<initial-value>0</initial-value>\n				<max-value>999999</max-value>\n				<update-increment>1000</update-increment>\n				<sequence-name>VnPayID</sequence-name>\n			</id-generator>\n		</vnpay>	\n	</settings>\n</aitime>	','xml',NULL),('vnpay','config','settings.vnpay.inquiry-time','180000','prop',NULL),('vnpay','config','settings.vnpay.max-seq-error','5','prop',NULL),('vnpay','config','settings.vnpay.merchant-type','6014','prop',NULL),('vnpay','config','settings.vnpay.messages','<aitime>\n	<settings>\n		<vnpay>\n			<messages>\n				<message type=\"0200\">\n					<field num=\"1\"    length=\"32\"  lengthIndicator=\"0\" name=\"bitmap\">F0004001000100010000000000000001</field>\n					<field num=\"2\"    length=\"0\"   lengthIndicator=\"2\" name=\"msisdn\"></field>\n					<field num=\"3\"    length=\"6\"   lengthIndicator=\"0\" name=\"processing code\"></field>\n					<field num=\"4\"    length=\"12\"  lengthIndicator=\"0\" name=\"transaction amount\"></field>\n					<field num=\"18\"   length=\"4\"   lengthIndicator=\"0\" name=\"merchant type\"></field>\n					<field num=\"32\"   length=\"0\"   lengthIndicator=\"2\" name=\"agent code\"></field>\n					<field num=\"48\"   length=\"0\"   lengthIndicator=\"3\" name=\"additional information\"></field>\n					<field num=\"64\"   length=\"16\"  lengthIndicator=\"0\" name=\"mac1\"></field>\n					<field num=\"128\"  length=\"16\"  lengthIndicator=\"0\" name=\"mac2\"></field>\n				</message>\n				<message type=\"0210\">\n					<field num=\"1\"    length=\"32\"  lengthIndicator=\"0\" name=\"bitmap\"></field>\n					<field num=\"2\"    length=\"0\"   lengthIndicator=\"2\" name=\"msisdn\"></field>\n					<field num=\"3\"    length=\"6\"   lengthIndicator=\"0\" name=\"processing code\"></field>\n					<field num=\"4\"    length=\"12\"  lengthIndicator=\"0\" name=\"transaction amount\"></field>\n					<field num=\"18\"   length=\"4\"   lengthIndicator=\"0\" name=\"merchant type\"></field>\n					<field num=\"32\"   length=\"0\"   lengthIndicator=\"2\" name=\"agent code\"></field>\n					<field num=\"39\"   length=\"2\"   lengthIndicator=\"0\" name=\"response code\"></field>\n					<field num=\"48\"   length=\"0\"   lengthIndicator=\"3\" name=\"additional information\"></field>\n					<field num=\"64\"   length=\"16\"  lengthIndicator=\"0\" name=\"mac1\"></field>\n					<field num=\"128\"  length=\"16\"  lengthIndicator=\"0\" name=\"mac2\"></field>\n				</message>\n				<message type=\"0800\">\n					<field num=\"1\"    length=\"32\"  lengthIndicator=\"0\" name=\"bitmap\">82200001000000000400000000000000</field>\n					<field num=\"7\"    length=\"10\"  lengthIndicator=\"0\" name=\"transaction date\"></field>\n					<field num=\"11\"   length=\"6\"   lengthIndicator=\"0\" name=\"transaction id\"></field>\n					<field num=\"32\"   length=\"0\"   lengthIndicator=\"0\" name=\"agent code\"></field>\n					<field num=\"70\"   length=\"3\"   lengthIndicator=\"0\" name=\"network code\"></field>\n				</message>\n				<message type=\"0810\">\n					<field num=\"1\"    length=\"32\"  lengthIndicator=\"0\" name=\"bitmap\"></field>\n					<field num=\"7\"    length=\"10\"  lengthIndicator=\"0\" name=\"transaction date\"></field>\n					<field num=\"11\"   length=\"6\"   lengthIndicator=\"0\" name=\"transaction id\"></field>\n					<field num=\"32\"   length=\"0\"   lengthIndicator=\"2\" name=\"agent code\"></field>\n					<field num=\"39\"   length=\"2\"   lengthIndicator=\"0\" name=\"response code\"></field>\n					<field num=\"70\"   length=\"3\"   lengthIndicator=\"0\" name=\"network code\"></field>\n				</message>\n				<message type=\"0210-48\">\n					<field num=\"1\"    length=\"0\"   lengthIndicator=\"3\" name=\"tag01\"></field>\n					<field num=\"2\"    length=\"0\"   lengthIndicator=\"3\" name=\"tag02\"></field>\n					<field num=\"3\"    length=\"0\"   lengthIndicator=\"3\" name=\"tag03\"></field>\n					<field num=\"4\"    length=\"0\"   lengthIndicator=\"3\" name=\"tag04\"></field>\n				</message>\n			</messages>\n		</vnpay>	\n	</settings>\n</aitime>	','xml',NULL),('vnpay','config','settings.vnpay.network-check-code','301','prop',NULL),('vnpay','config','settings.vnpay.network-check-delivery-wfp','wfpVnpayNetworkCheckAfterQueue','prop',NULL),('vnpay','config','settings.vnpay.network-check-wfp','wfpVnpayNetworkCheckPushToQueue','prop',NULL),('vnpay','config','settings.vnpay.network-login-code','001','prop',NULL),('vnpay','config','settings.vnpay.network-logout-code','002','prop',NULL),('vnpay','config','settings.vnpay.no-response.response-codes','INVALID_RESPONSE,DELIVERY_RESPONSE_ERROR','prop',NULL),('vnpay','config','settings.vnpay.queue-id','VNPAY_DELIVERY','prop',NULL),('vnpay','config','settings.vnpay.response-codes','<aitime>\n	<settings>\n		<vnpay>\n			<response-codes>\n				<response-code src=\"00\" dest=\"SUCCESS\">Successful transaction\"</response-code>\n		        <response-code src=\"01\" dest=\"TRANSACTION_FAILED\">Topup error</response-code>\n		        <response-code src=\"08\" dest=\"TRANSACTION_FAILED\">VNPAY system does not response (timeout)</response-code>\n		        <response-code src=\"11\" dest=\"MISISDN_NOT_EXISTED\" >mobile phone number does not exist</response-code>\n		        <response-code src=\"12\" dest=\"MISISDN_NOT_EXISTED\" >Mobile phone number has not activated</response-code>\n		        <response-code src=\"51\" dest=\"TRANSACTION_FAILED\" >Transaction is not valid</response-code>\n		        <response-code src=\"61\" dest=\"TRANSACTION_FAILED\" >Topup amount is not valid</response-code>\n		        <response-code src=\"62\" dest=\"SYS_NOT_ENOUGH_MONEY\" >Topup amount is larger than the allowed amount</response-code>\n		        <response-code src=\"71\" dest=\"TRANSACTION_FAILED\" >Transaction date is not valid</response-code>\n		        <response-code src=\"81\" dest=\"TRANSACTION_FAILED\" >Transaction time is not valid</response-code>\n		        <response-code src=\"79\" dest=\"TRANSACTION_FAILED\" >MAC value is not valid</response-code>\n		        <response-code src=\"99\" dest=\"TRANSACTION_FAILED\" >VNPAY system is not on operation or on maintenance</response-code>\n		    </response-codes>\n		</vnpay>	\n	</settings>\n</aitime>','xml',NULL),('vnpay','config','settings.vnpay.response-time-out','60000','prop',NULL),('vnpay','config','settings.vnpay.secret-key','MBV553286','prop',NULL),('vnpay','config','settings.vnpay.success.response-codes','00,0,SUCCESS','prop',NULL),('vnpay','config','settings.vnpay.topup-processing-code','000000','prop',NULL),('vnpay','config','settings.vnpay.trace-date-format','yyyyMMdd','prop',NULL),('vnpay','config','settings.vnpay.transaction-date-format','yyyyMMddHHmmss','prop',NULL);

DROP TABLE IF EXISTS `cdr_data`;
CREATE TABLE `cdr_data` (
  `provider_id` varchar(50) NOT NULL DEFAULT '',
  `message_id` varchar(20) NOT NULL DEFAULT '',
  `at_txn_id` bigint(20) NOT NULL DEFAULT '0',
  `created_by` varchar(45) NOT NULL,
  `txn_date` datetime DEFAULT NULL,
  `method` varchar(50) DEFAULT NULL,
  `agent_name` varchar(20) DEFAULT NULL,
  `msisdn` varchar(20) DEFAULT NULL,
  `amount` int(12) DEFAULT NULL,
  `error_code` varchar(100) DEFAULT NULL,
  `request` varchar(400) DEFAULT NULL,
  `response` varchar(400) DEFAULT NULL,
  `ext0` varchar(100) DEFAULT NULL,
  `ext1` varchar(45) DEFAULT NULL,
  `ext2` varchar(45) DEFAULT NULL,
  `ext3` varchar(45) DEFAULT NULL,
  `ext4` varchar(45) DEFAULT NULL,
  `status` varchar(45) DEFAULT NULL,
  PRIMARY KEY (`provider_id`,`message_id`,`at_txn_id`,`created_by`),
  KEY `index1` (`provider_id`,`created_by`,`message_id`,`at_txn_id`,`error_code`),
  KEY `index2` (`created_by`),
  KEY `index3` (`provider_id`,`created_by`,`message_id`,`error_code`),
  KEY `index4` (`provider_id`,`created_by`,`txn_date`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

DROP TABLE IF EXISTS `async_req_temp`;
CREATE TABLE `async_req_temp` (
  `at_txn_id` bigint(20) NOT NULL,
  `operator_type` varchar(100) DEFAULT NULL,
  `value` varchar(2000) DEFAULT NULL,
  `status` varchar(100) DEFAULT NULL,
  `txn_date` datetime DEFAULT NULL,
  `error_code` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`at_txn_id`),
  KEY `operator_type_index` (`operator_type`),
  KEY `txn_date_index` (`txn_date`),
  KEY `status_index` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=ascii;

CREATE VIEW `txn_summary_view` AS select cast((`airtime`.`at_transaction`.`txn_date` + interval _utf8'7:00:00' hour_second) as date) AS `txn_date_gmt7`,`airtime`.`at_transaction`.`conn_type` AS `provider_id`,sum(`airtime`.`at_transaction`.`amount`) AS `used_amount`,count(`airtime`.`at_transaction`.`at_txn_id`) AS `total_txn` from `airtime`.`at_transaction` where ((`airtime`.`at_transaction`.`txn_status` = _ascii'SUCCESS') and (`airtime`.`at_transaction`.`deleted` = _utf8'0')) group by cast((`airtime`.`at_transaction`.`txn_date` + interval _utf8'7:00:00' hour_second) as date),`airtime`.`at_transaction`.`conn_type`;

CREATE VIEW `provider_money_summary_view` AS select cast((`provider_account`.`txn_date` + interval _utf8'7:00:00' hour_second) as date) AS `txn_date_gmt7`,`provider_account`.`provider_id` AS `provider_id`,sum(`provider_account`.`total_amount`) AS `total_amount`,sum(`provider_account`.`input_amount`) AS `total_input_amount` from `provider_account` where (`provider_account`.`deleted` = 0) group by cast((`provider_account`.`txn_date` + interval _utf8'7:00:00' hour_second) as date),`provider_account`.`provider_id`;

CREATE VIEW `txn_provider_summary_view` AS select `a`.`txn_date_gmt7` AS `txn_date_gmt7`,`a`.`provider_id` AS `provider_id`,ifnull(`a`.`used_amount`,0) AS `used_amount`,ifnull(`a`.`total_txn`,0) AS `total_txn`,ifnull(`b`.`total_amount`,0) AS `total_amount`,ifnull(`b`.`total_input_amount`,0) AS `total_input_amount` from (`txn_summary_view` `a` left join `provider_money_summary_view` `b` on(((`a`.`txn_date_gmt7` = `b`.`txn_date_gmt7`) and (`a`.`provider_id` = `b`.`provider_id`)))) union select `a`.`txn_date_gmt7` AS `txn_date_gmt7`,`a`.`provider_id` AS `provider_id`,0 AS `used_amount`,0 AS `total_txn`,ifnull(`a`.`total_amount`,0) AS `total_amount`,ifnull(`a`.`total_input_amount`,0) AS `total_input_amount` from `provider_money_summary_view` `a` where (not(exists(select `b`.`txn_date_gmt7` AS `txn_date_gmt7` from `txn_summary_view` `b` where ((`a`.`provider_id` = `b`.`provider_id`) and (`b`.`txn_date_gmt7` = `a`.`txn_date_gmt7`)))));

CREATE VIEW `at_summary_view` AS select 
'0' AS `begin_amount`,
`a`.`txn_date_gmt7` AS `txn_date`,
`a`.`provider_id` AS `provider_id`,
`a`.`used_amount` AS `used_amount`,
`a`.`total_txn` AS `total_txn`,
`a`.`total_amount` AS `total_amount`,
`a`.`total_input_amount` AS `total_input_amount`,
'0' AS `end_amount` 
from `airtime`.`txn_provider_summary_view` `a` order by `a`.`txn_date_gmt7`;


CREATE VIEW `cdr_comparison_view` AS 
		select a.*, 'MATCHED' as result from `cdr_data` a, `cdr_data` b where 
		a.provider_id='MOBI' and a.created_by='MOBIVI' and a.provider_id=b.provider_id and b.created_by='MOBIFONE' and
		a.message_id=b.message_id and a.at_txn_id=b.at_txn_id and 
		a.error_code=b.error_code 
		union
		select a.*, 'UNMATCHED' as result from  `cdr_data` a where 
		a.provider_id='MOBI' and a.created_by='MOBIVI' and
		a.txn_date<=(select max(txn_date) from `cdr_data` b where b.created_by='MOBIFONE') and
		not exists(select c.message_id from `cdr_data` c where 
		    a.provider_id=c.provider_id and c.created_by='MOBIFONE' and
		a.message_id=c.message_id and a.at_txn_id=c.at_txn_id and 
		a.error_code=c.error_code
		)
		union
		select a.*, 'UNMATCHED' as result from  `cdr_data` a where 
		a.provider_id='MOBI' and a.created_by='MOBIFONE' and
		a.txn_date<=(select max(txn_date) from `cdr_data` b where b.created_by='MOBIVI') and
		not exists(select c.message_id from `cdr_data` c where 
		    a.provider_id=c.provider_id and c.created_by='MOBIVI' and
		a.message_id=c.message_id and a.at_txn_id=c.at_txn_id and 
		a.error_code=c.error_code
		)
		union
		select a.*, 'MATCHED' as result from `cdr_data` a, `cdr_data` b where 
		a.provider_id='VTEL' and a.created_by='MOBIVI' and a.provider_id=b.provider_id and b.created_by='VIETTEL' and
		a.message_id=b.message_id and 
		a.error_code=b.error_code 
		union
		select a.*, 'UNMATCHED' as result from  `cdr_data` a where 
		a.provider_id='VTEL' and a.created_by='MOBIVI' and
		a.txn_date<=(select max(txn_date) from `cdr_data` b where b.created_by='VIETTEL') and
		not exists(select c.message_id from `cdr_data` c where 
		    a.provider_id=c.provider_id and c.created_by='VIETTEL' and
		a.message_id=c.message_id and 
		a.error_code=c.error_code
		)
		union
		select a.*, 'UNMATCHED' as result from  `cdr_data` a where 
		a.provider_id='VTEL' and a.created_by='VIETTEL' and
		a.txn_date<=(select max(txn_date) from `cdr_data` b where b.created_by='MOBIVI') and
		not exists(select c.message_id from `cdr_data` c where 
		    a.provider_id=c.provider_id and c.created_by='MOBIVI' and
		a.message_id=c.message_id and 
		a.error_code=c.error_code
		);
        
   update provider_amount set total_used =(select sum(amount) from at_transaction where txn_status='SUCCESS' and conn_type='VNPAY') where provider_id='VNPAY';   
  
